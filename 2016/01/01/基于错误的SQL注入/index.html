<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<link rel="stylesheet" type="text/css" href="/css/main.css?v="/>
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
<title> 基于错误的SQL注入 | 时针它不停在转动 </title>
</head>
<body>
<div id="">
<header id="header" class="header"><div class="header_wrapper">
<h1 class="title">
<a href="/">时针它不停在转动</a>
</h1>

<ul class="nav">


<li>
<a href="/">首页</a>
</li>


<li>
<a href="/archives">归档</a>
</li>


<li>
<a href="/about">关于</a>
</li>

</ul>
</div>
</header>
<main id="main" class="main">
<section id="content" class="content ">

  <div id="posts" class="posts-expand">
    
<article class="post">
<header class="post-header">
<h1 class="post-title">

基于错误的SQL注入
</a>

</h1>
<div class="post-meta">
<span class="post-time">2016-01-01</span>
<span class="post-category">

&nbsp; | &nbsp;
<a class="post-cat-link" href="/categories/网络安全/">
网络安全
</a>

</span>
</div>
</header>

<span class="articleBody"><h1 id="基于错误的SQL注入"><a href="#基于错误的SQL注入" class="headerlink" title="基于错误的SQL注入"></a>基于错误的SQL注入</h1><h2 id="最前面的话"><a href="#最前面的话" class="headerlink" title="最前面的话"></a>最前面的话</h2><ul>
<li>预备知识<ul>
<li>SQL基础知识，包括数据库增、删、改、查等SQL基础语句以及聚合函数、子查询等一些高级语法。</li>
<li>编程知识，包括使用编程语言提供的操纵数据库接口，如PHP中的mysql系列函数。</li>
</ul>
</li>
<li>文章以<a href="https://github.com/Audi-1/sqli-labs" target="_blank" rel="external">sqli-labs</a>作为学习环境，大家可以在本地下载安装</li>
<li>文章会努力从如何攻击、剖析原因、防范横向叙述，从读取数据、提权纵向延伸。</li>
<li>文章会定期更新，也是对自己学习的监督。</li>
<li>文中不当之处，敬请指出，望不吝赐教。</li>
</ul>
<p>第一篇文章先介绍基于错误的SQL注入，简言之，输入畸形数据后，我们可以回显的错误信息，我们根据错误信息帮助我们进行注入。本文结构如下：</p>
<blockquote>
<p>概要</p>
<ul>
<li>联合查询 Union Select<ul>
<li>字符型 String</li>
<li>整型 Intiger</li>
<li>手工注入攻击</li>
</ul>
</li>
<li>子查询或双查询 Double</li>
</ul>
</blockquote>
<h2 id="联合查询-Union-Select"><a href="#联合查询-Union-Select" class="headerlink" title="联合查询 Union Select"></a>联合查询 Union Select</h2><h3 id="字符型-String"><a href="#字符型-String" class="headerlink" title="字符型 String"></a>字符型 String</h3><h4 id="攻击测试"><a href="#攻击测试" class="headerlink" title="攻击测试"></a>攻击测试</h4><p>sqli-labs中<strong>less-1 Error Based-String</strong>,我们输入<em>?id=1</em>,正常显示用户名和密码。输入畸形数据<em>?id=1’</em>,报错如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">You have an error in your SQL syntax; <span class="keyword">check</span> the <span class="keyword">manual</span> that corresponds <span class="keyword">to</span> your MySQL </div><div class="line"><span class="keyword">server</span> <span class="keyword">version</span> <span class="keyword">for</span> the <span class="keyword">right</span> syntax <span class="keyword">to</span> <span class="keyword">use</span> near <span class="string">''</span><span class="number">1</span><span class="string">''</span> <span class="keyword">LIMIT</span> <span class="number">0</span>,<span class="number">1</span><span class="string">' at line 1</span></div></pre></td></tr></table></figure></p>
<p>错误中提示，我们在SQL语法错误，在第一行的’’1’’ LIMIT 0,1’附近。其中，<strong>‘1’</strong>的两边有单引号，由于我们刚才在<strong>1</strong>的后面加的单引号，导致解析异常。通过错误我们发现，在SQL语句中，参数<strong>1</strong>是作为字符串进行查询的，故我们把这种类型的SQL注入称之为<strong>基于错误的字符型注入</strong>。注：可以是单引号、双引号</p>
<h4 id="源代码分析"><a href="#源代码分析" class="headerlink" title="源代码分析"></a>源代码分析</h4><p>SQL语句：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">users</span> <span class="keyword">WHERE</span> <span class="keyword">id</span>=<span class="string">'$id'</span> <span class="keyword">LIMIT</span> <span class="number">0</span>,<span class="number">1</span>;</div></pre></td></tr></table></figure></p>
<p>输入正常是SQL语句：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">users</span> <span class="keyword">WHERE</span> <span class="keyword">id</span>=<span class="string">'1'</span> <span class="keyword">LIMIT</span> <span class="number">0</span>,<span class="number">1</span>;</div></pre></td></tr></table></figure></p>
<p>畸形数据时SQL语句：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">users</span> <span class="keyword">WHERE</span> <span class="keyword">id</span>=<span class="string">'1'' LIMIT 0,1;</span></div></pre></td></tr></table></figure></p>
<p>通过上述两条SQL语句，是把id作为字符形式进行查询，故可以理解为基于错误的<strong>字符型</strong>注入。<br>那么错误是怎么显示出来的？在源代码有一下语句：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$result</span>=mysql_query(<span class="variable">$sql</span>);</div><div class="line"><span class="variable">$row</span> = mysql_fetch_array(<span class="variable">$result</span>);</div><div class="line"><span class="comment">#var_dump($row);</span></div><div class="line"><span class="keyword">if</span>(<span class="variable">$row</span>)</div><div class="line">&#123;</div><div class="line">...</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span> </div><div class="line">&#123;</div><div class="line">	<span class="built_in">echo</span> <span class="string">'&lt;font color= "#FFFF00"&gt;'</span>;</div><div class="line">	print_r(mysql_error());</div><div class="line">	<span class="built_in">echo</span> <span class="string">"&lt;/font&gt;"</span>;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>print_r(mysql_error())</strong>语句在异常时，输出错误信息。<br>通过上面简单的源代码分析，可以理解<strong>基于错误的字符型注入</strong>。</p>
<h3 id="整型-Intiger"><a href="#整型-Intiger" class="headerlink" title="整型 Intiger"></a>整型 Intiger</h3><p><strong>基于错误的整型注入</strong>和上面类似。简要叙述。</p>
<h4 id="攻击测试-1"><a href="#攻击测试-1" class="headerlink" title="攻击测试"></a>攻击测试</h4><p>sqli-labs中<strong>less-2 Error Based-Intiger</strong>,我们输入<em>?id=1</em>,正常显示用户名和密码。输入畸形数据<em>?id=1’</em>,报错如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">You have an error in your SQL syntax; <span class="keyword">check</span> the <span class="keyword">manual</span> that corresponds <span class="keyword">to</span> your MySQL </div><div class="line"><span class="keyword">server</span> <span class="keyword">version</span> <span class="keyword">for</span> the <span class="keyword">right</span> syntax <span class="keyword">to</span> <span class="keyword">use</span> near <span class="string">''</span> <span class="keyword">LIMIT</span> <span class="number">0</span>,<span class="number">1</span><span class="string">' at line 1</span></div></pre></td></tr></table></figure></p>
<p><strong>注意！上述报错信息与上一条有区别。</strong>对比如下：<br>第一条 <strong>‘1’’ LIMIT 0,1</strong><br>第二条 <strong>‘ LIMIT 0,1</strong><br>第一条中1，第二条中没有。说明第二条中，我们输入的单引号没有打乱原本的单引号闭合策略。详细看源代码分析。</p>
<h4 id="源代码分析-1"><a href="#源代码分析-1" class="headerlink" title="源代码分析"></a>源代码分析</h4><p>SQL语句：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">users</span> <span class="keyword">WHERE</span> <span class="keyword">id</span>=$<span class="keyword">id</span> <span class="keyword">LIMIT</span> <span class="number">0</span>,<span class="number">1</span>;</div></pre></td></tr></table></figure></p>
<p>正常试:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">users</span> <span class="keyword">WHERE</span> <span class="keyword">id</span>=<span class="number">1</span> <span class="keyword">LIMIT</span> <span class="number">0</span>,<span class="number">1</span>;</div></pre></td></tr></table></figure></p>
<p>异常时：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">users</span> <span class="keyword">WHERE</span> <span class="keyword">id</span>=<span class="number">1</span><span class="string">' LIMIT 0,1;</span></div></pre></td></tr></table></figure></p>
<p>这里id以整型带入SQL语句查询。故理解为<strong>基于错误的整型注入</strong>。</p>
<h3 id="手工注入攻击"><a href="#手工注入攻击" class="headerlink" title="手工注入攻击"></a>手工注入攻击</h3><h2 id="子查询-Double"><a href="#子查询-Double" class="headerlink" title="子查询 Double"></a>子查询 Double</h2></span>

<footer class="post-footer">

<a class="post-tag-link" href="/tags/sql注入/">#sql注入</a>



<div class="post-nav">
	<div class="post-nav-prev post-nav-item">
	
		<a rel="prev" href="/2016/09/19/Linux下硬盘备份与恢复/">Linux下硬盘备份与恢复</a>
	
    </div>
    <div class="post-nav-next post-nav-item">
    
    	<a rel="next" href="/2015/12/07/内网端口转发/">内网端口转发</a>
    
    </div>
</div>

</footer>
</article>


    <div class="post-spread">
      
    </div>
  </div>

</section>
</main>
<footer class="footer" id="footer">
<div class="copyright">
<i class="fa fa-copyright">2015-2017</i>
</div>
</footer>
</div>



</body>
</html>